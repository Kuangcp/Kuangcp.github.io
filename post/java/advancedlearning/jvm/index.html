<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>JVM - Mythos · Java Developer</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="Kuangcp" /><meta name="description" content="💠 JVM 1.1. JVM参数 1.2. Unified JVM Logging 1.3. JVM内存参数 1.3.1. 容器内的JVM 1.3.2. 内存参数实践 JVM 基本结构 内存区域 3.1. 运行时数据区 3.1.1. 程序计数器 3.1.2. Java虚拟机栈 3.1.3. 本地方" /><meta name="keywords" content="Hugo, theme, even" />






<meta name="generator" content="Hugo 0.99.0 with theme even" />


<link rel="canonical" href="https://www.kuangcp.top/post/java/advancedlearning/jvm/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.b5a744db6de49a86cadafb3b70f555ab443f83c307a483402259e94726b045ff.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="JVM" />
<meta property="og:description" content="💠 JVM 1.1. JVM参数 1.2. Unified JVM Logging 1.3. JVM内存参数 1.3.1. 容器内的JVM 1.3.2. 内存参数实践 JVM 基本结构 内存区域 3.1. 运行时数据区 3.1.1. 程序计数器 3.1.2. Java虚拟机栈 3.1.3. 本地方" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.kuangcp.top/post/java/advancedlearning/jvm/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2019-04-02T10:56:52+00:00" />
<meta property="article:modified_time" content="2019-04-02T10:56:52+00:00" />

<meta itemprop="name" content="JVM">
<meta itemprop="description" content="💠 JVM 1.1. JVM参数 1.2. Unified JVM Logging 1.3. JVM内存参数 1.3.1. 容器内的JVM 1.3.2. 内存参数实践 JVM 基本结构 内存区域 3.1. 运行时数据区 3.1.1. 程序计数器 3.1.2. Java虚拟机栈 3.1.3. 本地方"><meta itemprop="datePublished" content="2019-04-02T10:56:52+00:00" />
<meta itemprop="dateModified" content="2019-04-02T10:56:52+00:00" />
<meta itemprop="wordCount" content="6667">
<meta itemprop="keywords" content="JVM," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="JVM"/>
<meta name="twitter:description" content="💠 JVM 1.1. JVM参数 1.2. Unified JVM Logging 1.3. JVM内存参数 1.3.1. 容器内的JVM 1.3.2. 内存参数实践 JVM 基本结构 内存区域 3.1. 运行时数据区 3.1.1. 程序计数器 3.1.2. Java虚拟机栈 3.1.3. 本地方"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Mythos</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Mythos</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">JVM</h1>

      <div class="post-meta">
        <span class="post-time"> 2019-04-02 </span>
        <div class="post-category">
            <a href="/categories/java/"> Java </a>
            </div>
          <span class="more-meta"> 6667 words </span>
          <span class="more-meta"> 14 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#jvm">JVM</a>
      <ul>
        <li><a href="#jvm参数">JVM参数</a></li>
        <li><a href="#unified-jvm-logging">Unified JVM Logging</a></li>
        <li><a href="#jvm内存参数">JVM内存参数</a>
          <ul>
            <li><a href="#容器内的jvm">容器内的JVM</a></li>
            <li><a href="#内存参数实践">内存参数实践</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#jvm-基本结构">JVM 基本结构</a></li>
    <li><a href="#内存区域">内存区域</a>
      <ul>
        <li><a href="#运行时数据区">运行时数据区</a>
          <ul>
            <li><a href="#程序计数器">程序计数器</a></li>
            <li><a href="#java虚拟机栈">Java虚拟机栈</a></li>
            <li><a href="#本地方法栈">本地方法栈</a></li>
            <li><a href="#heap-堆">Heap 堆</a></li>
            <li><a href="#方法区-java7">方法区 Java7</a></li>
          </ul>
        </li>
        <li><a href="#native-memory-非堆内存">Native Memory 非堆内存</a>
          <ul>
            <li><a href="#nmt-native-memory-tracking">NMT Native Memory Tracking</a></li>
            <li><a href="#metaspace-元空间">Metaspace 元空间</a></li>
            <li><a href="#directmemory-堆外内存">DirectMemory 堆外内存</a></li>
            <li><a href="#code-cache">Code Cache</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#jvm不同实现">JVM不同实现</a>
      <ul>
        <li><a href="#hotspot-jvm">Hotspot JVM</a></li>
        <li><a href="#openj9">OpenJ9</a></li>
        <li><a href="#graalvm">GraalVM</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>💠</p>
<ul>
<li>
<ol>
<li><a href="#jvm">JVM</a></li>
</ol>
<ul>
<li>1.1. <a href="#jvm%E5%8F%82%E6%95%B0">JVM参数</a></li>
<li>1.2. <a href="#unified-jvm-logging">Unified JVM Logging</a></li>
<li>1.3. <a href="#jvm%E5%86%85%E5%AD%98%E5%8F%82%E6%95%B0">JVM内存参数</a>
<ul>
<li>1.3.1. <a href="#%E5%AE%B9%E5%99%A8%E5%86%85%E7%9A%84jvm">容器内的JVM</a></li>
<li>1.3.2. <a href="#%E5%86%85%E5%AD%98%E5%8F%82%E6%95%B0%E5%AE%9E%E8%B7%B5">内存参数实践</a></li>
</ul>
</li>
</ul>
</li>
<li>
<ol start="2">
<li><a href="#jvm-%E5%9F%BA%E6%9C%AC%E7%BB%93%E6%9E%84">JVM 基本结构</a></li>
</ol>
</li>
<li>
<ol start="3">
<li><a href="#%E5%86%85%E5%AD%98%E5%8C%BA%E5%9F%9F">内存区域</a></li>
</ol>
<ul>
<li>3.1. <a href="#%E8%BF%90%E8%A1%8C%E6%97%B6%E6%95%B0%E6%8D%AE%E5%8C%BA">运行时数据区</a>
<ul>
<li>3.1.1. <a href="#%E7%A8%8B%E5%BA%8F%E8%AE%A1%E6%95%B0%E5%99%A8">程序计数器</a></li>
<li>3.1.2. <a href="#java%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%A0%88">Java虚拟机栈</a></li>
<li>3.1.3. <a href="#%E6%9C%AC%E5%9C%B0%E6%96%B9%E6%B3%95%E6%A0%88">本地方法栈</a></li>
<li>3.1.4. <a href="#heap-%E5%A0%86">Heap 堆</a>
<ul>
<li>3.1.4.1. <a href="#%E5%A0%86%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E7%AD%96%E7%95%A5">堆内存分配策略</a></li>
</ul>
</li>
<li>3.1.5. <a href="#%E6%96%B9%E6%B3%95%E5%8C%BA-java7">方法区 Java7</a></li>
</ul>
</li>
<li>3.2. <a href="#native-memory-%E9%9D%9E%E5%A0%86%E5%86%85%E5%AD%98">Native Memory 非堆内存</a>
<ul>
<li>3.2.1. <a href="#nmt-native-memory-tracking">NMT Native Memory Tracking</a></li>
<li>3.2.2. <a href="#metaspace-%E5%85%83%E7%A9%BA%E9%97%B4">Metaspace 元空间</a></li>
<li>3.2.3. <a href="#directmemory-%E5%A0%86%E5%A4%96%E5%86%85%E5%AD%98">DirectMemory 堆外内存</a></li>
<li>3.2.4. <a href="#code-cache">Code Cache</a></li>
</ul>
</li>
</ul>
</li>
<li>
<ol start="4">
<li><a href="#jvm%E4%B8%8D%E5%90%8C%E5%AE%9E%E7%8E%B0">JVM不同实现</a></li>
</ol>
<ul>
<li>4.1. <a href="#hotspot-jvm">Hotspot JVM</a></li>
<li>4.2. <a href="#openj9">OpenJ9</a></li>
<li>4.3. <a href="#graalvm">GraalVM</a></li>
</ul>
</li>
</ul>
<p>💠 2024-12-10 22:28:33</p>
<hr>
<h1 id="jvm">JVM</h1>
<blockquote>
<p>JVM结构及设计</p>
</blockquote>
<p>Oracle JDK 默认采用的是 Hotspot JVM</p>
<blockquote>
<p><a href="https://docs.oracle.com/javase/specs/">Java Language and Virtual Machine Specifications</a></p>
</blockquote>
<blockquote>
<p><a href="https://github.com/xwjie/jvm">Github:jvm学习仓库</a>
<a href="https://vinoit.me/tags/jvm/">个人博客: JVM归类</a></p>
</blockquote>
<p><code>书籍</code></p>
<ul>
<li>《深入理解 Java 虚拟机》(周志明 第二版) 大部分内容来源于此, 但是部分内容是依据Java8有所改动</li>
</ul>
<p><code>社区</code></p>
<ul>
<li><a href="https://club.perfma.com/">prefma</a></li>
</ul>
<h2 id="jvm参数">JVM参数</h2>
<blockquote>
<p><a href="https://docs.oracle.com/javase/8/docs/technotes/tools/unix/java.html">Command Reference for JDK8</a> | <a href="https://docs.oracle.com/en/java/javase/17/docs/specs/man/java.html">Command Reference for JDK17</a><br>
<a href="https://www.oracle.com/java/technologies/javase/vmoptions-jsp.html">Official: Java HotSpot VM Options</a><br>
<a href="https://www.baeldung.com/jvm-parameters">Guide to the Most Important JVM Parameters</a></p>
</blockquote>
<blockquote>
<p><a href="https://journal.kazmodan.com/docs/%E7%BC%96%E7%A8%8B%E7%94%9F%E6%80%81/Java/JVM/JVM%E5%90%AF%E5%8A%A8%E5%8F%82%E6%95%B0%E9%85%8D%E7%BD%AE%E5%BB%BA%E8%AE%AE/">Jvm启动参数配置建议 | 郭工gyf的记录</a></p>
</blockquote>
<ul>
<li>
<p><a href="/Java/AdvancedLearning/JavaDebug.md#%E8%BF%9C%E7%A8%8B%E8%B0%83%E8%AF%95">远程调试</a></p>
</li>
<li>
<p><code>-Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.port=9999 -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false</code></p>
<ul>
<li>开启无需认证 非SSL的JMX端口: 9999</li>
</ul>
</li>
<li>
<p><code>-XX:+TraceClassLoading -XX:+TraceClassUnloading</code> 输出类装载/卸载日志，可用于排查类从哪个jar加载进入JVM的</p>
<ul>
<li>Java9及以后替代为： <code>-Xlog:class+load=info</code></li>
</ul>
</li>
</ul>
<blockquote>
<p>OOM</p>
</blockquote>
<ul>
<li><code>-XX:+HeapDumpOnOutOfMemoryError </code></li>
<li><code>-XX:HeapDumpPath=./java_pid&lt;pid&gt;.hprof</code> 注意路径需要存在，JVM不会创建不存在的目录</li>
<li><code>-XX:OnOutOfMemoryError=&quot;&lt; cmd args &gt;;&lt; cmd args &gt;&quot; </code></li>
<li><code>-XX:+UseGCOverheadLimit</code></li>
</ul>
<blockquote>
<p>字符串</p>
</blockquote>
<ul>
<li>-XX:+UseStringCache</li>
<li>-XX:+UseCompressedStrings</li>
<li>-XX:+OptimizeStringConcat</li>
<li>-XX:+UseStringDeduplication</li>
</ul>
<blockquote>
<p>编译类参数</p>
</blockquote>
<ul>
<li>CICompilerCount是JIT进行热点编译的线程数，和并发标记线程数一样，热点编译也是CPU密集型任务，默认值为2。
在CICompilerCountPerCPU开启的时候（JDK7默认关闭，JDK8默认开启），手动指定CICompilerCount是不会生效的，JVM会使用系统CPU核数进行计算。
所以当使用JRE8并且版本小于1.8.0_131，采用默认参数时，CICompilerCount会在20左右，对业务性能影响较大，特别是启动阶段。建议升级Java版本，特殊情况要使用老版本Java 8，请加上<code>-XX:CICompilerCount=[n]</code>, 同时不能指定-XX:+CICompilerCountPerCPU ，下表给出了生产环境下常见规格的推荐值。</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:left">CPU核数</th>
<th style="text-align:left">1</th>
<th style="text-align:left">2</th>
<th style="text-align:left">4</th>
<th style="text-align:left">8</th>
<th style="text-align:left">16</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">推荐值</td>
<td style="text-align:left">2</td>
<td style="text-align:left">2</td>
<td style="text-align:left">3</td>
<td style="text-align:left">3</td>
<td style="text-align:left">8</td>
</tr>
</tbody>
</table>
<h2 id="unified-jvm-logging">Unified JVM Logging</h2>
<blockquote>
<p><a href="https://openjdk.org/jeps/158">JEP 158: Unified JVM Logging</a></p>
</blockquote>
<p>Java9开始，整合了GC，类加载等日志配置方式，日志级别，输出方式 正交式声明使用，更统一及灵活。</p>
<h2 id="jvm内存参数">JVM内存参数</h2>
<blockquote>
<p>堆(老年代 年轻代)，堆外，元空间，栈</p>
</blockquote>
<blockquote>
<p>内存参数设置的考量： Xmx * 110% + MaxDirectMemorySize + 系统预留内存 &lt;= 容器内存</p>
</blockquote>
<ul>
<li>Xmx * 110% 中额外的10%是留给其他堆外内存的，是个保守估计，个别业务运行时线程较多时，还需加上 Xss * 线程数</li>
<li>系统预留内存512M到1G，视容器规格而定</li>
<li>I/O较多的业务适当提高MaxDirectMemorySize比例（Netty和NIO使用到）</li>
</ul>
<p>快速确认进程内存配置</p>
<table>
<thead>
<tr>
<th style="text-align:left">工具</th>
<th style="text-align:left">命令</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Arthas</td>
<td style="text-align:left"><code>jvm</code></td>
</tr>
<tr>
<td style="text-align:left">OpenJDK</td>
<td style="text-align:left"><code>jcmd pid GC.heap_info</code></td>
</tr>
<tr>
<td style="text-align:left">OracleJDK</td>
<td style="text-align:left"><code>jmap -heap pid</code></td>
</tr>
</tbody>
</table>
<ul>
<li><code>-XX:CompressedClassSpaceSize=500m</code> 压缩的类元空间大小 默认是1g</li>
<li><code>-XX:SurvivorRatio</code> 配置 Edgen 和 单个Survivor 的比例, 如果配置为2 则是 2:1:1。 <strong>默认是8</strong></li>
<li><code>-XX:NewRatio</code>old/new 内存的比值 <strong>默认是2</strong></li>
<li><code>-Xmn</code> MaxNewSize 默认值是<code>Xmx</code>的1/3 即最大堆内存 MaxHeapSize 的1/3</li>
<li><code>-Xss</code> 设置 ThreadStackSize 线程的栈内存大小 默认值 1024k</li>
<li><code>-XX:+AlwaysPreTouch</code> 堆内存分配时，直接分配物理内存而不是虚拟内存，分配的物理内存会做0值初始化（单线程执行），好处是后续申请内存时无须分配和初始化，缺点是启动更耗时。
<ul>
<li>申请内存的场景（年轻代晋升，新对象分配）</li>
</ul>
</li>
</ul>
<blockquote>
<p>java -XX:+PrintFlagsFinal -version</p>
</blockquote>
<ul>
<li><code>-XX:+PrintFlagsInitial</code> 输出初始默认值</li>
<li><code>-XX:+PrintFlagsFinal</code> 输出JVM最终属性值
<ul>
<li>MaxHeapSize 最大堆内存</li>
<li>MaxRAMFraction 默认最大内存占物理机内存的比例 JDK6，7，8 都是4 即1/4</li>
<li>NUMA 机制</li>
<li><code>java -XX:+PrintFlagsFinal -version | grep &quot;Use.*GC&quot;</code> 查看默认GC实现</li>
</ul>
</li>
<li><code>-XshowSettings:VM</code> 展示VM和系统信息</li>
</ul>
<hr>
<p>需要理解，但是不用，尽量使用明确的 Xmx Xms</p>
<blockquote>
<p><a href="https://www.baeldung.com/java-jvm-parameters-rampercentage">JVM Parameters InitialRAMPercentage, MinRAMPercentage, and MaxRAMPercentage</a></p>
</blockquote>
<ul>
<li>MinRAMPercentage, MaxRAMPercentage 其实都是<strong>设置堆默认最大值</strong>的， Max 和 Min 换成 Big Small可能更好理解(大内存环境和小内存环境 <code>200M划分</code>)</li>
<li><code>-XX:InitialRAMPercentage</code> 初始堆使用值 默认1.5625， 当配置了 <code>-Xms</code> 时，该配置将被忽略</li>
<li>InitialRAMFraction MaxRAMFraction  MinRAMFraction DefaultMaxRAMFraction 4等分值</li>
</ul>
<hr>
<h3 id="容器内的jvm">容器内的JVM</h3>
<p>容器无法感知资源限制， 8U191/10b34 及以上版本才支持</p>
<ul>
<li>快速实验某个Java版本的默认参数和限制 docker run -m 100MB openjdk:8 java -XX:MinRAMPercentage=80.0 -XshowSettings:VM -version</li>
<li><a href="http://www.techug.com/post/java-and-docker-memory-limits.html">参考: Java和Docker限制的那些事儿</a><code>天坑： 低版本的Jvm无法感知到Docker的资源限制</code></li>
<li><input disabled="" type="checkbox"> 但是有的Linux版本在后续的版本也无法感知，例如 1.8.0_342 10.0.2 仍取的主机内存, Linux 5.15内核 Manjaro23.1</li>
</ul>
<ol>
<li><a href="https://stackoverflow.com/questions/64262912/java-prior-to-jdk8-update-131-applications-running-in-docker-container-cpu-m">Java (prior to JDK8 update 131) applications running in docker container CPU / Memory issues?</a></li>
<li><a href="https://dzone.com/articles/best-practices-java-memory-arguments-for-container">Best Practices: Java Memory Arguments for Containers</a></li>
</ol>
<p>总结： <strong>尽量使用 Xms Xmx</strong>，而不是 RAMPercentage RAMFractionc参数（还要结合容器或宿主机计算实际值），降低维护和理解成本，控制更灵活精确，且支持所有版本JVM，不用考虑兼容性问题</p>
<p>参数：</p>
<ul>
<li>-XX:ActiveProcessorCount=$CONTAINER_CORE_LIMIT 强制设置CPU量 从downawrd_api获取</li>
<li>-Xlog:os+container=logLevel JVM报告容器信息</li>
<li>-XX:-UseContainerSupport 关闭容器支持，默认开启</li>
</ul>
<hr>
<h3 id="内存参数实践">内存参数实践</h3>
<blockquote>
<p><a href="https://gceasy.ycrash.cn/gc-recommendations/benefits-of-setting-initial-and-maximum-memory-size.jsp">初始和最大堆内存设置为一样的好处</a>
<a href="https://blog.ycrash.io/benefits-of-setting-initial-and-maximum-memory-size-to-the-same-value/">Benefits of setting initial and maximum memory size to the same value</a></p>
</blockquote>
<ul>
<li>避免扩容的暂停事件，提前调度充足资源的容器防止运行期扩容而被Linux被OOMKiller杀掉</li>
</ul>
<blockquote>
<p><a href="http://ifeve.com/useful-jvm-flags-part-1-jvm-types-and-compiler-modes-2/">参考: JVM实用参数（一）JVM类型以及编译器模式</a><br>
<a href="http://xxfox.perfma.com/">xxfox</a><code>Jvm参数辅助工具</code><br>
<a href="https://blog.mythsman.com/post/5d2c12cc67f841464434a3ec/">参考: JVM动态反优化</a></p>
</blockquote>
<hr>
<h1 id="jvm-基本结构">JVM 基本结构</h1>
<p><img src="img/004-jvm-structure.drawio.svg" alt="JVM基本结构"></p>
<ul>
<li>类加载器子系统
<ul>
<li>负责从文件系统或者网络中记载Class信息，加载的类信息存放于一块称为方法区的内存空间。除了类的信息外，方法区中可能还会存放运行时的常量池信息，包含字符串字面量和数字常量（这部分常量信息是Class文件中常量池部分的内存映射）</li>
</ul>
</li>
<li>Java堆
<ul>
<li>在虚拟机启动的时候建立，他是Java程序最主要的内存工作区域。几乎所有Java对象实例都存放于Java堆中。堆空间是所有线程共享的，这是一块与Java应用密切相关的内存区间</li>
<li>Java的NIO库允许Java程序使用直接内存。直接内存是Java堆外的、直接向系统申请的内存区间。通常，访问直接内存的速度优于Java堆。因此出于性能考虑，读写频繁的场合可能会考虑使用直接内存。由于直接内存在Java堆外，因此他的大小不会直接受限于Xmx指定的最大堆大小，但是系统内存是有限的，Java堆和直接内存的总和依然受限于操作系统能给出的最大内存</li>
</ul>
</li>
<li>垃圾回收系统
<ul>
<li>是Java虚拟机的重要组成部分，垃圾回收器可以对方法区、Java堆和直接内存进行回收。其中，Java堆是垃圾回收器的工作重点。和C/C++不同，Java中所有的对象空间释放都是隐式的。也就是说，Java中没有类似free()和delete()这样的函数释放指定的内存区域，对于不再使用的垃圾对象，垃圾回收系统会在后台默默工作，默默查找、标识并释放垃圾对象，完成Java堆、方法区和直接内存中的全自动管理。</li>
</ul>
</li>
<li>Java虚拟机栈
<ul>
<li>每一个Java虚拟机线程都有一个私有的Java栈。一个线程的Java栈在线程创建的时候被创建。Java栈中保存着帧信息，Java栈中保存着局部变量、方法参数，同时和Java方法的调用、返回密切相关。</li>
</ul>
</li>
<li>本地方法栈
<ul>
<li>和Java栈非常类似，最大的不同在于Java栈用于Java方法的调用，而本地方法栈则用于本地方法调用。作为Java虚拟机的重要扩展，Java虚拟机允许Java直接调用本地方法。</li>
</ul>
</li>
<li>PC寄存器
<ul>
<li>也是每个线程私有的空间，Java虚拟机会为每一个Java线程创建PC寄存器。在任意时刻，一个Java线程总是在执行一个方法，这个正在被执行的方法称为当前方法。如果当前方法不是一个本地方法，PC寄存器就会指向当前正在被执行的指令。如果当前方法是本地方法，那么PC寄存器的值就是undefined。</li>
</ul>
</li>
<li>执行引擎
<ul>
<li>是Java虚拟机的最核心组件之一，它负责执行虚拟机的字节码。</li>
</ul>
</li>
</ul>
<hr>
<h1 id="内存区域">内存区域</h1>
<p><img src="./img/007-jvm-memory.webp" alt="alt text"></p>
<p><code>glibc</code></p>
<p>注意所有内存的申请和返还都是通过 glibc 实现的，因此不建议使用Alpine作为基础镜像，因为会有行为上的不一致，Alpine使用的是 musl libc(核心源码只有不到 400 行)。<br>
不过标准的glibc库也有一些设计需要关心，例如 MALLOC_ARENA_MAX 。</p>
<blockquote>
<p><a href="https://juejin.cn/post/6844903574154002445">从一次 CTF 出题谈 musl libc 堆漏洞利用本文通过一道 CTF 题目展示 musl libc 堆溢出漏洞的利 - 掘金</a></p>
</blockquote>
<hr>
<blockquote>
<p><a href="https://www.pengzna.top/article/Java-Memory/">Java 进程内存占用及可观测性调研&amp;内存异常排查最佳实践</a><code>深入探究内存分布细节</code><br>
<a href="https://developer.jdcloud.com/article/2740">谈JVM xmx, xms等内存相关参数合理性设置</a></p>
</blockquote>
<blockquote>
<p><a href="https://stackoverflow.com/questions/1612939/why-does-the-sun-jvm-continue-to-consume-ever-more-rss-memory-even-when-the-heap">java - Why does the Sun JVM continue to consume ever more RSS memory even when the heap, etc sizes are stable? - Stack Overflow</a></p>
</blockquote>
<h2 id="运行时数据区">运行时数据区</h2>
<p><img src="./img/008-jvm-run-memory-area.webp" alt="alt text"></p>
<p><img src="img/001-jvm-runtime-memory.drawio.svg" alt=""></p>
<p>线程私有的内存区域: 程序计数器 本地方法栈 虚拟机栈. 生命周期与线程保持一致</p>
<h3 id="程序计数器">程序计数器</h3>
<p>可以看作是当前线程所执行的字节码的行号指示器, 这个内存区域是唯一一个在JVM规范中没有规定任何 OutOfMemoryError 的区域</p>
<h3 id="java虚拟机栈">Java虚拟机栈</h3>
<blockquote>
<p>HotSpot 中不区分Java虚拟机栈和本地方法栈, 虽然 -Xoss 存在(设置本地方法栈大小)但是是无效的, 只能通过 -Xss 设置 且可以通过NMT看到所有线程数及占用的非堆内存</p>
</blockquote>
<p><img src="img/002-method-stack.drawio.svg" alt=""></p>
<ul>
<li>
<p>虚拟机栈描述的是Java方法执行的内存模型: 每个方法在执行的同时, 都会创建一个<code>栈帧</code>(Stack Frame)</p>
<ul>
<li>用于存储局部变量表, 操作数栈, 动态链接, 方法出口等信息</li>
<li>在一个栈帧中，至少要包含局部变量表、操作数栈和帧数据。</li>
</ul>
</li>
<li>
<p>每个方法调用到执行完成的过程, 就对应着一个栈帧在虚拟机栈中入栈到出栈的过程</p>
</li>
<li>
<p>局部变量表</p>
<ul>
<li>存放了编译期可知的各种 基本数据类型, 对象引用, returnAddress 类型
<ul>
<li>对象引用: reference 类型, 不等同于对象本身, 可能是一个指向对象地址的引用指针, 可能是一个代表对象的句柄, (可能是其他与此对象相关的位置?)</li>
<li>returnAddress: 指向了一条字节码指令的地址</li>
</ul>
</li>
<li>只有 long double 类型 会占用 2 个局部变量空间, 其他类型都只占用 1 个</li>
<li>局部变量表所需的内存空间在编译后就已经确定下来, 运行期是不会变的</li>
</ul>
</li>
<li>
<p>Java虚拟机规范中对该内存区域定义了两种异常状况</p>
<ul>
<li>如果线程请求的栈深度大于虚拟机所允许的最大深度, 将抛出 StackOverFlowError</li>
<li>如果虚拟机在扩展栈时, 无法申请到足够的内存, 则抛出 OutOfMemoryError 异常</li>
</ul>
</li>
</ul>
<h3 id="本地方法栈">本地方法栈</h3>
<p>Native Method Stack, 与虚拟机栈所发挥的作用是相似的, 只不过虚拟机栈是为虚拟机执行Java方法服务, 本地方法栈是为了虚拟机使用 Native 方法服务</p>
<h3 id="heap-堆">Heap 堆</h3>
<blockquote>
<p>Java虚拟机规范中的描述是 所有对象实例以及数组都是在堆上分配, 但是由于 JIT编译器 逃逸分析 栈上分配, 标量替换等技术, 就变得没那么绝对了</p>
</blockquote>
<p>堆分为 新生代(包含: Eden, Survivor from, Survivor to) 老年代<br>
从堆和栈的功能和作用来通俗的比较,堆主要用来存放对象的，栈主要是用来执行程序的.<br>
JVM是基于堆栈的虚拟机.JVM为每个新创建的线程都分配一个堆栈.也就是说,对于一个Java程序来说，它的运行就是通过对堆栈的操作来完成的。<br>
堆栈以栈帧为单位保存线程的状态。JVM对堆栈只进行两种操作:以帧为单位的压栈和出栈操作。</p>
<blockquote>
<p><a href="http://www.cnblogs.com/whgw/archive/2011/09/29/2194997.html">参考: Java中堆内存和栈内存详解</a></p>
</blockquote>
<h4 id="堆内存分配策略">堆内存分配策略</h4>
<ul>
<li>对象的内存分配, 粗略讲就是在堆上分配(但也可能经过JIT编译后被拆散成标量类型并间接地栈上分配)</li>
<li>对象主要分配在Eden; 如果启动了本地线程分配缓冲, 则优先在TLAB上分配; 也有直接分配在老年代的 (长字符串以及数组)</li>
</ul>
<ol>
<li><code>类变量</code>（static修饰的变量） 在程序加载时系统就为它在堆中开辟了内存，堆中的内存地址存放于栈以便于高速访问。
<ul>
<li>生命周期: 从应用进程启动一直到进程停止</li>
</ul>
</li>
<li><code>实例变量</code> 当你使用java关键字new的时候，系统在堆中开辟并不一定是连续的空间分配给变量（比如说类实例），然后根据零散的堆内存地址，通过哈希算法换算为一长串数字以表征这个变量在堆中的&quot;物理位置&quot;。
<ul>
<li>生命周期: 当实例变量的引用丢失后，将被GC（垃圾回收器）列入可回收“名单”中，但并不是马上就释放堆中内存</li>
</ul>
</li>
<li><code>局部变量</code> 局部变量，由声明在某方法，或某代码段里（比如for循环），执行到它的时候在栈中开辟内存
<ul>
<li>生命周期: 当局部变量一但脱离作用域，内存立即释放</li>
</ul>
</li>
</ol>
<hr>
<ul>
<li>如果对象在 Eden 出生, 并经过一次 MinorGC后存活, 并能被 Survivor 容纳, 将被移入 Survivor 且年龄为1.
<ul>
<li>对象在 Survivor 每经过一次 MinorGC 年龄加1, 当达到 MaxTenuringThreshold(默认15) 就会移入老年代</li>
</ul>
</li>
<li>如果 Survivor 空间中相同年龄所有对象大小的总和大于 Survivor 空间的一半, 年龄大于等于该年龄的对象都将进入老年代, 无需等到设置的 MaxTenuringThreshold</li>
</ul>
<blockquote>
<p>堆内存配置: 新生代一般设置为整个堆空间的1/3到1/4左右最合适。<br>
新生代内存不能过大也不能过小, 过大则老年代内存过小, 导致频繁 FullGC<br>
过小则导致对象全在老年代分配,新生代上无法分配(Allocation Failure) 也将导致频繁 Full GC</p>
</blockquote>
<h3 id="方法区-java7">方法区 Java7</h3>
<p>方法区存在于永久代 Perm Gen, 对应于Java8中的MetaSpace</p>
<p>用于存放 Class 相关信息, 常量, 静态变量, 访问修饰符, 字段描述, 方法描述, JIT编译器编译后的代码等数据<br>
在 HotSpot 虚拟机上, 方法区也看做是 永久代 Permanent Gen, 两者关系是: 方法区是Java虚拟机规范, 永久代是方法区在Hotspot上的实现<br>
从Java8开始, 永久代已经被 MetaSpace(操作系统的直接内存) 取代</p>
<p>JDK7中符号表被移动到 Native Heap中，字符串常量池和类引用被移动到 Java Heap中。</p>
<p>运行时常量池是方法区的一部分, 用于存放编译期生成的各种字面量和符号引用,这部分内容将在类加载后进入方法区的运行时常量池存放.</p>
<h2 id="native-memory-非堆内存">Native Memory 非堆内存</h2>
<p>Native Memory 主要是JNI、线程栈、编译器、符号表、Deflater/Inflater、DirectByteBuffer（nio中会用到）使用的</p>
<p>当发现Java进程的堆使用率不高，但是进程占用内存RSS很高，就要怀疑这块区域了</p>
<ul>
<li><a href="https://github.com/Kuangcp/JavaBase/blob/master/class/src/test/java/jvm/oom/DirectMemoryOOMTest.java">Github: 测试代码</a></li>
</ul>
<blockquote>
<p><a href="https://cloud.tencent.com/developer/article/1129904">参考: 聊聊JVM 堆外内存泄露的BUG是如何查找的</a><br>
<a href="https://zhuanlan.zhihu.com/p/60976273">JAVA堆外内存排查小结</a><br>
<a href="https://blog.malt.engineering/java-in-k8s-how-weve-reduced-memory-usage-without-changing-any-code-cbef5d740ad">Java in K8s: how we’ve reduced memory usage without changing any code</a></p>
</blockquote>
<blockquote>
<p><a href="https://www.pengzna.top/article/Java-Memory/">Java 进程内存占用及可观测性调研&amp;内存异常排查最佳实践</a></p>
</blockquote>
<p>还有两种内存 Native Memory Tracking 没有记录，那就是：</p>
<ul>
<li>MMap Buffer：文件映射内存</li>
<li>JNI 方法里的内存分配</li>
</ul>
<blockquote>
<p><a href="https://www.bro-code.in/blog/java-debugging-native-memory-leak">Java – Debugging Native Memory Leaks</a></p>
</blockquote>
<h3 id="nmt-native-memory-tracking">NMT Native Memory Tracking</h3>
<blockquote>
<p><a href="https://docs.oracle.com/javase/8/docs/technotes/guides/troubleshoot/tooldescr007.html">Native Memory Tracking</a></p>
</blockquote>
<blockquote>
<p><a href="https://docs.oracle.com/javase/8/docs/technotes/guides/troubleshoot/tooldescr022.html#BABHIFJC">NMT Memory Categories</a><code>内存各分类说明</code></p>
</blockquote>
<ul>
<li>启用NMT: java -XX:NativeMemoryTracking=summary 或者 detail 开销更大一些</li>
<li>查看NMT: jcmd $pid VM.native_memory <code>[detail] 对应启用时设置，输出具体内存地址信息</code>
<ul>
<li>summary 缺省参数，查看概览</li>
<li>detail detail模式才支持，查看内存地址明细</li>
<li>baseline 设置当前时刻为基线</li>
<li>summary.diff 对比前文设置的基线的变化值</li>
<li>detail.diff detail模式对比前文设置的基线的变化值</li>
<li>shutdown 停止 Tracking</li>
<li>scale 设置展示的单位值默认KB (MB or GB)</li>
<li>statistics detail模式输出统计信息</li>
</ul>
</li>
</ul>
<blockquote>
<p>示例</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">Native Memory Tracking:
</span></span><span class="line"><span class="cl">Total: <span class="nv">reserved</span><span class="o">=</span>10019737KB, <span class="nv">committed</span><span class="o">=</span>997089KB <span class="o">()</span> reversed保留内存 （ps中的VSZ）  commited实际提交内存 （ps中的RSS）
</span></span><span class="line"><span class="cl">-                 Java Heap <span class="o">(</span><span class="nv">reserved</span><span class="o">=</span>8222720KB, <span class="nv">committed</span><span class="o">=</span>514048KB<span class="o">)</span>
</span></span><span class="line"><span class="cl">                            <span class="o">(</span>mmap: <span class="nv">reserved</span><span class="o">=</span>8222720KB, <span class="nv">committed</span><span class="o">=</span>514048KB<span class="o">)</span> 
</span></span><span class="line"><span class="cl">-                     Class <span class="o">(</span><span class="nv">reserved</span><span class="o">=</span>1081845KB, <span class="nv">committed</span><span class="o">=</span>34165KB<span class="o">)</span> 存储类元数据信息
</span></span><span class="line"><span class="cl">                            <span class="o">(</span>classes <span class="c1">#3085)</span>
</span></span><span class="line"><span class="cl">                            <span class="o">(</span><span class="nv">malloc</span><span class="o">=</span>14837KB <span class="c1">#3960) </span>
</span></span><span class="line"><span class="cl">                            <span class="o">(</span>mmap: <span class="nv">reserved</span><span class="o">=</span>1067008KB, <span class="nv">committed</span><span class="o">=</span>19328KB<span class="o">)</span> 
</span></span><span class="line"><span class="cl">-                    Thread <span class="o">(</span><span class="nv">reserved</span><span class="o">=</span>54501KB, <span class="nv">committed</span><span class="o">=</span>54501KB<span class="o">)</span>  线程占用的空间 即54线程 54M：默认栈为1M需-Xss修改
</span></span><span class="line"><span class="cl">                            <span class="o">(</span>thread <span class="c1">#54)</span>
</span></span><span class="line"><span class="cl">                            <span class="o">(</span>stack: <span class="nv">reserved</span><span class="o">=</span>54272KB, <span class="nv">committed</span><span class="o">=</span>54272KB<span class="o">)</span>
</span></span><span class="line"><span class="cl">                            <span class="o">(</span><span class="nv">malloc</span><span class="o">=</span>178KB <span class="c1">#318) </span>
</span></span><span class="line"><span class="cl">                            <span class="o">(</span><span class="nv">arena</span><span class="o">=</span>52KB <span class="c1">#95)</span>
</span></span><span class="line"><span class="cl">-                      Code <span class="o">(</span><span class="nv">reserved</span><span class="o">=</span>250763KB, <span class="nv">committed</span><span class="o">=</span>9551KB<span class="o">)</span> JIT代码缓存
</span></span><span class="line"><span class="cl">                            <span class="o">(</span><span class="nv">malloc</span><span class="o">=</span>1163KB <span class="c1">#2588) </span>
</span></span><span class="line"><span class="cl">                            <span class="o">(</span>mmap: <span class="nv">reserved</span><span class="o">=</span>249600KB, <span class="nv">committed</span><span class="o">=</span>8388KB<span class="o">)</span> 
</span></span><span class="line"><span class="cl">-                        GC <span class="o">(</span><span class="nv">reserved</span><span class="o">=</span>316571KB, <span class="nv">committed</span><span class="o">=</span>291487KB<span class="o">)</span> GC算法需要的内存空间
</span></span><span class="line"><span class="cl">                            <span class="o">(</span><span class="nv">malloc</span><span class="o">=</span>16151KB <span class="c1">#155) </span>
</span></span><span class="line"><span class="cl">                            <span class="o">(</span>mmap: <span class="nv">reserved</span><span class="o">=</span>300420KB, <span class="nv">committed</span><span class="o">=</span>275336KB<span class="o">)</span> 
</span></span><span class="line"><span class="cl">-                  Compiler <span class="o">(</span><span class="nv">reserved</span><span class="o">=</span>183KB, <span class="nv">committed</span><span class="o">=</span>183KB<span class="o">)</span>
</span></span><span class="line"><span class="cl">                            <span class="o">(</span><span class="nv">malloc</span><span class="o">=</span>40KB <span class="c1">#208) </span>
</span></span><span class="line"><span class="cl">                            <span class="o">(</span><span class="nv">arena</span><span class="o">=</span>142KB <span class="c1">#15)</span>
</span></span><span class="line"><span class="cl">-                  Internal <span class="o">(</span><span class="nv">reserved</span><span class="o">=</span>84975KB, <span class="nv">committed</span><span class="o">=</span>84975KB<span class="o">)</span>  DirectMemory区域
</span></span><span class="line"><span class="cl">                            <span class="o">(</span><span class="nv">malloc</span><span class="o">=</span>84943KB <span class="c1">#16310) </span>
</span></span><span class="line"><span class="cl">                            <span class="o">(</span>mmap: <span class="nv">reserved</span><span class="o">=</span>32KB, <span class="nv">committed</span><span class="o">=</span>32KB<span class="o">)</span> 
</span></span><span class="line"><span class="cl">-                    Symbol <span class="o">(</span><span class="nv">reserved</span><span class="o">=</span>4984KB, <span class="nv">committed</span><span class="o">=</span>4984KB<span class="o">)</span>
</span></span><span class="line"><span class="cl">                            <span class="o">(</span><span class="nv">malloc</span><span class="o">=</span>3633KB <span class="c1">#26295) </span>
</span></span><span class="line"><span class="cl">                            <span class="o">(</span><span class="nv">arena</span><span class="o">=</span>1351KB <span class="c1">#1)</span>
</span></span><span class="line"><span class="cl">-    Native Memory Tracking <span class="o">(</span><span class="nv">reserved</span><span class="o">=</span>982KB, <span class="nv">committed</span><span class="o">=</span>982KB<span class="o">)</span> NMT自身占用内存
</span></span><span class="line"><span class="cl">                            <span class="o">(</span><span class="nv">malloc</span><span class="o">=</span>163KB <span class="c1">#2304) </span>
</span></span><span class="line"><span class="cl">                            <span class="o">(</span>tracking <span class="nv">overhead</span><span class="o">=</span>818KB<span class="o">)</span>
</span></span><span class="line"><span class="cl">-               Arena Chunk <span class="o">(</span><span class="nv">reserved</span><span class="o">=</span>2214KB, <span class="nv">committed</span><span class="o">=</span>2214KB<span class="o">)</span>
</span></span><span class="line"><span class="cl">                            <span class="o">(</span><span class="nv">malloc</span><span class="o">=</span>2214KB<span class="o">)</span> 
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h3 id="metaspace-元空间">Metaspace 元空间</h3>
<blockquote>
<p>MetaSpace Java8 引入, 取代了以往的 Perm Gen</p>
</blockquote>
<ul>
<li>存放内容：
<ul>
<li>Klass结构</li>
<li>匿名类， Lambda表达式</li>
<li>String.intern 的字符串</li>
</ul>
</li>
</ul>
<blockquote>
<p>特性</p>
</blockquote>
<ul>
<li>充分利用了Java语言规范：类及相关的元数据的生命周期与类加载器的一致。</li>
<li>每个类加载器都有它的内存区域-元空间</li>
<li>只进行线性分配</li>
<li>不会单独回收某个类（除了重定义类 RedefineClasses 或类加载失败）</li>
<li>没有GC扫描或压缩</li>
<li>元空间里的对象不会被转移</li>
<li>如果GC发现某个类加载器不再存活，会对整个元空间进行集体回收</li>
</ul>
<blockquote>
<p><a href="https://stuefe.de/posts/metaspace/metaspace-architecture/">参考: Metaspace Architecture</a><br>
<a href="https://stuefe.de/posts/metaspace/what-is-compressed-class-space/">参考: What is Compressed Class Space?</a><br>
<a href="https://www.javadoop.com/post/metaspace">深入理解堆外内存 Metaspace</a></p>
</blockquote>
<p><a href="https://heapdump.cn/article/210111">Metaspace 解密 - 你假笨</a></p>
<p>-XX:MaxMetaspaceSize 指定元空间的最大空间，默认值是无限（16EB）
-XX:MetaspaceSize 指定元空间首次扩充的大小，默认为20.75M</p>
<p>由于MaxMetaspaceSize未指定时，默认无上限，所以需要特别关注内存泄露的问题<br>
如果程序动态的创建了很多类（反射，Lambda等等）或出现过java.lang.OutOfMemoryError:Metaspace， 建议明确指定-XX:MaxMetaspaceSize</p>
<p>Metaspace实际分配的大小是随着需要逐步扩大的，<strong>每次扩大需要执行一次FGC</strong>，-XX:MetaspaceSize默认的值是比较小的，需要频繁GC扩充到实际需要的大小。<br>
类似日志可以看到Metaspace引起的FGC：<code>[Full GC (Metadata GC Threshold) ...]</code>， 因此为减少预热影响，可以将-XX:MetaspaceSize，-XX:MaxMetaspaceSize指定成相同的值。</p>
<h3 id="directmemory-堆外内存">DirectMemory 堆外内存</h3>
<p>常说的堆外内存都是指这块，即NIO使用到的缓冲区内存（直接操作系统申请，不受GC控制）。<br>
通常出现在NMT监控中的 Internal 部分，如果发现这部分增长明显，需要排查NIO相关的代码使用和配置了。</p>
<ul>
<li>
<p><a href="https://stackoverflow.com/questions/2689914/how-to-see-the-memory-usage-of-nio-buffers">how to see memory useage of nio buffers</a></p>
</li>
<li>
<p><code>-XX:MaxDirectMemorySize</code> 限制最大内存</p>
<ul>
<li>该参数只能限制 DirectByteBuffer（Bits）申请内存的最大值，无法限制Unsafe申请内存</li>
<li><code>如果未手动指定值，通过jcmd工具查看的值为0,实际取值参考：</code>
<ul>
<li>使用CMS,Parallel GC时默认值为： MaxHeapSize - Survivor</li>
<li>使用G1时最大默认是 MaxHeapSize</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="code-cache">Code Cache</h3>
<blockquote>
<p><a href="https://www.baeldung.com/jvm-code-cache">Introduction to JVM Code Cache</a></p>
</blockquote>
<hr>
<h1 id="jvm不同实现">JVM不同实现</h1>
<h2 id="hotspot-jvm">Hotspot JVM</h2>
<p>原先 SUN 公司开发, 现为 Oracle JDK 中默认JVM</p>
<h2 id="openj9">OpenJ9</h2>
<p>IBM主导开发, 捐赠给Eclipse基金会</p>
<blockquote>
<p><a href="http://www.eclipse.org/openj9/">Officail Site</a> | <a href="https://www.ibm.com/support/knowledgecenter/SSYKE2_8.0.0/com.ibm.java.vm.80.doc/docs/j9_intro.html">IBM原文</a> | <a href="https://eclipse.dev/openj9/docs/">技术文档</a></p>
</blockquote>
<blockquote>
<p><a href="http://www.infoq.com/cn/news/2017/09/IBM-JVM-OpenJ9-Eclipse">参考: IBM开源JVM实现OpenJ9，并提交Eclipse基金会托管)</a>
<a href="http://www.infoq.com/cn/news/2018/03/OMR-OpenJ9">参考: Eclipse Open J9：Eclipse OMR项目提供的开源JVM</a></p>
</blockquote>
<hr>
<h2 id="graalvm">GraalVM</h2>
<blockquote>
<p><a href="https://www.graalvm.org/">Official Site</a></p>
</blockquote>
<blockquote>
<p><a href="https://www.graalvm.org/latest/docs/getting-started/">Doc</a></p>
</blockquote>
<ul>
<li>安装 graalvm <code>sdk install java 17.0.11-graal</code></li>
<li>跟随样例中执行 native-image HelloWorld， 可以发现会占满16核CPU<code>AMD 3700x</code>和1G左右内存，20s才可以编译完成</li>
</ul>
<blockquote>
<p><a href="https://www.graalvm.org/java/advantages/">Accelerating Java performance</a><code>基准测试宣称快于openjdk8和11 1.55倍</code>
<a href="https://docs.spring.io/spring-boot/docs/current/reference/html/native-image.html">GraalVM Native Image Support</a></p>
</blockquote>
<hr>
<blockquote>
<p><a href="https://www.infoq.cn/article/2018%2F05%2Foracle-graalvm-v1">参考: Oracle 发布多语种虚拟机平台 GraalVM 1.0</a><br>
<a href="https://zhuanlan.zhihu.com/p/35849246">参考: 全栈虚拟机GraalVM初体验</a></p>
</blockquote>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">Kuangcp</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">
        2019-04-02
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/jvm/">JVM</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/java/advancedlearning/javaserialize/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Java中的序列化</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/skills/devops/elk/">
            <span class="next-text nav-default">ELK.md</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="https://github.com/Kuangcp" class="iconfont icon-github" title="github"></a>
  <a href="https://www.kuangcp.top/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://gitee.com/gin9/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2016 - 
    2024<span class="heart"><i class="iconfont icon-heart"></i></span>
    <span>Kuangcp</span>
    
    <br/><span><a href='http://beian.miit.gov.cn/'; target=_blank>赣ICP备17014189号</a></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.64437849d125a2d603b3e71d6de5225d641a32d17168a58106e0b61852079683.js"></script>








</body>
</html>
